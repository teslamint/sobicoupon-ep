name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

env:
  NODE_VERSION: '20'

jobs:
  # PR ì •ë³´ ë° ë³€ê²½ì‚¬í•­ ë¶„ì„
  pr-analysis:
    name: PR Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write

    outputs:
      has-frontend-changes: ${{ steps.changes.outputs.frontend }}
      has-test-changes: ${{ steps.changes.outputs.tests }}
      files-changed: ${{ steps.changes.outputs.files }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            frontend:
              - 'public/**'
              - 'src/**'
              - '*.js'
              - '*.ts'
              - '*.html'
              - '*.css'
            tests:
              - 'tests/**'
              - '**/*.test.js'
              - '**/*.spec.js'
            config:
              - 'package.json'
              - 'pnpm-lock.yaml'
              - '.github/**'
              - 'playwright.config.js'
              - 'jest.config.js'

      - name: PR size check
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const { data: files } = await github.rest.pulls.listFiles({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.issue.number,
              });

              const additions = files.reduce((sum, file) => sum + file.additions, 0);
              const deletions = files.reduce((sum, file) => sum + file.deletions, 0);
              const totalChanges = additions + deletions;

              let sizeLabel = '';
              if (totalChanges < 100) sizeLabel = 'ğŸŸ¢ Small';
              else if (totalChanges < 500) sizeLabel = 'ğŸŸ¡ Medium';
              else if (totalChanges < 1000) sizeLabel = 'ğŸŸ  Large';
              else sizeLabel = 'ğŸ”´ XLarge';

              console.log(`PR ë¶„ì„ ê²°ê³¼: ${sizeLabel} (${totalChanges} ë¼ì¸ ë³€ê²½)`);
              console.log(`íŒŒì¼ ìˆ˜: ${files.length}, ì¶”ê°€: ${additions}, ì‚­ì œ: ${deletions}`);

              // PR ëŒ“ê¸€ ì‘ì„± ì‹œë„ (ì‹¤íŒ¨í•´ë„ ì›Œí¬í”Œë¡œëŠ” ê³„ì† ì§„í–‰)
              try {
                const comment = `## ğŸ“Š PR ë¶„ì„ ê²°ê³¼

                **í¬ê¸°**: ${sizeLabel} (${totalChanges} ë¼ì¸ ë³€ê²½)
                - â• ${additions} ë¼ì¸ ì¶”ê°€
                - â– ${deletions} ë¼ì¸ ì‚­ì œ
                - ğŸ“ ${files.length}ê°œ íŒŒì¼ ë³€ê²½

                **ë³€ê²½ì‚¬í•­ ìœ í˜•**:
                ${files.some(f => f.filename.includes('test')) ? 'âœ… í…ŒìŠ¤íŠ¸ íŒŒì¼ í¬í•¨' : 'âš ï¸ í…ŒìŠ¤íŠ¸ íŒŒì¼ ì—†ìŒ'}
                ${files.some(f => f.filename.includes('.md')) ? 'ğŸ“ ë¬¸ì„œ ë³€ê²½ í¬í•¨' : ''}
                `;

                if (github.event.pull_request && github.event.pull_request.number) {
                  await github.rest.issues.createComment({
                    issue_number: github.event.pull_request.number,
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    body: comment
                  });
                  console.log('PR ë¶„ì„ ëŒ“ê¸€ ì‘ì„± ì„±ê³µ');
                } else {
                  console.log('PR ì»¨í…ìŠ¤íŠ¸ê°€ ì—†ì–´ ëŒ“ê¸€ ì‘ì„±ì„ ê±´ë„ˆëœë‹ˆë‹¤.');
                }
              } catch (commentError) {
                console.log('PR ë¶„ì„ ëŒ“ê¸€ ì‘ì„± ì‹¤íŒ¨ (ê¶Œí•œ ë¬¸ì œì¼ ìˆ˜ ìˆìŒ):', commentError.message);
                // ëŒ“ê¸€ ì‘ì„± ì‹¤íŒ¨ëŠ” ë¬´ì‹œí•˜ê³  ê³„ì† ì§„í–‰
              }
            } catch (error) {
              console.error('PR ë¶„ì„ ì‹¤íŒ¨:', error);
              throw error;
            }

  # ë¹ ë¥¸ ê²€ì¦ (ë¦°íŠ¸, í¬ë§·íŒ…)
  quick-checks:
    name: Quick Checks
    runs-on: ubuntu-latest
    needs: pr-analysis

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ESLint check
        run: pnpm run lint:check

      - name: Prettier check
        run: pnpm run format:check

      - name: TypeScript check
        run: pnpm run type-check

  # í•µì‹¬ í…ŒìŠ¤íŠ¸ (ë³€ê²½ì‚¬í•­ì´ ìˆì„ ë•Œë§Œ)
  essential-tests:
    name: Essential Tests
    runs-on: ubuntu-latest
    needs: [pr-analysis, quick-checks]
    if: needs.pr-analysis.outputs.has-frontend-changes == 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run unit tests
        run: pnpm test

      - name: Build project
        run: pnpm run build
        env:
            CI: true
            KAKAO_API_KEY: test-key-for-ci

      - name: Install http-server
        run: npm install -g http-server

      - name: Install Playwright
        run: npx playwright install chromium --with-deps

      - name: Start static server
        run: |
          cd dist/public
          nohup http-server -p 8787 -c-1 --cors > server.log 2>&1 &
          SERVER_PID=$!
          echo "ì„œë²„ PID: $SERVER_PID"
          
          # ì„œë²„ê°€ ì™„ì „íˆ ì‹œì‘ë  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ê¸°
          for i in {1..30}; do
            if curl -f http://localhost:8787/ > /dev/null 2>&1; then
              echo "ì„œë²„ê°€ ì„±ê³µì ìœ¼ë¡œ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤ (ì‹œë„ $i/30)"
              break
            fi
            echo "ì„œë²„ ì‹œì‘ ëŒ€ê¸° ì¤‘... (ì‹œë„ $i/30)"
            sleep 2
          done
          
          # ìµœì¢… ìƒíƒœ í™•ì¸
          if ! curl -f http://localhost:8787/ > /dev/null 2>&1; then
            echo "ì„œë²„ ì‹œì‘ ì‹¤íŒ¨!"
            cat server.log
            exit 1
          fi
          
          echo "ì„œë²„ ì‘ë‹µ í…ŒìŠ¤íŠ¸:"
          curl -I http://localhost:8787/
        env:
          CI: true
          KAKAO_API_KEY: test-key-for-ci

      - name: Run smoke E2E tests (Chromium only)
        run: npx playwright test --project=chromium tests/e2e/smoke.spec.js
        env:
          CI: true
          KAKAO_API_KEY: test-key-for-ci

  # ë³´ì•ˆ ê²€ì‚¬
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: quick-checks

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Security audit
        run: pnpm audit --audit-level=high

  # PR ìƒíƒœ ìš”ì•½
  pr-status:
    name: PR Status Summary
    runs-on: ubuntu-latest
    needs: [quick-checks, essential-tests, security-scan]
    if: always()
    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Check results and comment
        uses: actions/github-script@v7
        with:
          script: |
            try {
              const needs = ${{ toJSON(needs) }};

              let status = 'âœ… ëª¨ë“  ê²€ì‚¬ í†µê³¼';
              let color = '28a745'; // ë…¹ìƒ‰

              const results = Object.entries(needs);
              const failed = results.filter(([, result]) => result.result === 'failure');
              const skipped = results.filter(([, result]) => result.result === 'skipped');

              if (failed.length > 0) {
                status = `âŒ ${failed.length}ê°œ ê²€ì‚¬ ì‹¤íŒ¨`;
                color = 'dc3545'; // ë¹¨ê°„ìƒ‰
              } else if (skipped.length > 0) {
                status = `âš ï¸ ${skipped.length}ê°œ ê²€ì‚¬ ê±´ë„ˆëœ€`;
                color = 'ffc107'; // ë…¸ë€ìƒ‰
              }

              console.log(`PR ê²€ì‚¬ ìƒíƒœ: ${status}`);
              console.log('ê²€ì‚¬ ê²°ê³¼:', results.map(([job, result]) => `${job}: ${result.result}`).join(', '));

              // PR ëŒ“ê¸€ ì‘ì„± ì‹œë„ (ì‹¤íŒ¨í•´ë„ ì›Œí¬í”Œë¡œëŠ” ê³„ì† ì§„í–‰)
              try {
                const comment = `## ğŸ” PR ê²€ì‚¬ ê²°ê³¼

                **ìƒíƒœ**: ${status}

                ### ìƒì„¸ ê²°ê³¼
                ${results.map(([job, result]) => {
                  const emoji = result.result === 'success' ? 'âœ…' :
                               result.result === 'failure' ? 'âŒ' :
                               result.result === 'skipped' ? 'â­ï¸' : 'ğŸŸ¡';
                  return `- ${emoji} **${job}**: ${result.result}`;
                }).join('\n')}

                ${failed.length > 0 ? 'âš ï¸ **ì‹¤íŒ¨í•œ ê²€ì‚¬ë¥¼ ìˆ˜ì •í•œ í›„ ë‹¤ì‹œ ì»¤ë°‹í•´ ì£¼ì„¸ìš”.**' : ''}
                ${status === 'âœ… ëª¨ë“  ê²€ì‚¬ í†µê³¼' ? 'ğŸ‰ **ì´ PRì€ ë³‘í•© ì¤€ë¹„ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!**' : ''}
                `;

                if (github.event.pull_request && github.event.pull_request.number) {
                  await github.rest.issues.createComment({
                    issue_number: github.event.pull_request.number,
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    body: comment
                  });
                  console.log('PR ìƒíƒœ ëŒ“ê¸€ ì‘ì„± ì„±ê³µ');
                } else {
                  console.log('PR ì»¨í…ìŠ¤íŠ¸ê°€ ì—†ì–´ ëŒ“ê¸€ ì‘ì„±ì„ ê±´ë„ˆëœë‹ˆë‹¤.');
                }
              } catch (commentError) {
                console.log('PR ìƒíƒœ ëŒ“ê¸€ ì‘ì„± ì‹¤íŒ¨ (ê¶Œí•œ ë¬¸ì œì¼ ìˆ˜ ìˆìŒ):', commentError.message);
                // ëŒ“ê¸€ ì‘ì„± ì‹¤íŒ¨ëŠ” ë¬´ì‹œí•˜ê³  ê³„ì† ì§„í–‰
              }
            } catch (error) {
              console.error('PR ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', error);
              throw error;
            }
