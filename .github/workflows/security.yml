name: Security Scans

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 3ì‹œì— ì‹¤í–‰
    - cron: '0 3 * * 1'

env:
  NODE_VERSION: '20'

jobs:
  dependency-scan:
    name: Dependency Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run pnpm audit
        run: |
          pnpm audit --audit-level=moderate --json > audit-results.json || true
          pnpm audit --audit-level=moderate

      - name: Process audit results
        run: |
          node -e "
          const fs = require('fs');
          const audit = JSON.parse(fs.readFileSync('audit-results.json', 'utf8'));
          
          if (audit.vulnerabilities && Object.keys(audit.vulnerabilities).length > 0) {
            console.log('ðŸ” ë°œê²¬ëœ ë³´ì•ˆ ì·¨ì•½ì :');
            Object.entries(audit.vulnerabilities).forEach(([pkg, vuln]) => {
              console.log(\`- \${pkg}: \${vuln.severity} (\${vuln.via.length} issues)\`);
            });
          } else {
            console.log('âœ… ë³´ì•ˆ ì·¨ì•½ì ì´ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
          }
          "

      - name: Upload audit results
        uses: actions/upload-artifact@v4
        with:
          name: security-audit
          path: audit-results.json
          retention-days: 30

  codeql-analysis:
    name: CodeQL Security Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript
          queries: security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v3

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:javascript"

  secret-scan:
    name: Secret Detection
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run TruffleHog
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: main
          head: HEAD
          extra_args: --debug --only-verified

  security-headers:
    name: Security Headers Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
      issues: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Start server
        run: |
          pnpm run dev &
          sleep 10
        env:
          CI: true

      - name: Check security headers
        run: |
          echo "## ðŸ”’ ë³´ì•ˆ í—¤ë” ê²€ì‚¬ ê²°ê³¼" > security-headers.md
          echo "" >> security-headers.md
          
          # CSP í—¤ë” í™•ì¸
          if curl -s -I http://localhost:8787 | grep -i "content-security-policy"; then
            echo "âœ… Content-Security-Policy í—¤ë” ì¡´ìž¬" >> security-headers.md
          else
            echo "âŒ Content-Security-Policy í—¤ë” ëˆ„ë½" >> security-headers.md
          fi
          
          # X-Frame-Options í™•ì¸
          if curl -s -I http://localhost:8787 | grep -i "x-frame-options"; then
            echo "âœ… X-Frame-Options í—¤ë” ì¡´ìž¬" >> security-headers.md
          else
            echo "âš ï¸ X-Frame-Options í—¤ë” ê¶Œìž¥" >> security-headers.md
          fi
          
          # X-Content-Type-Options í™•ì¸
          if curl -s -I http://localhost:8787 | grep -i "x-content-type-options"; then
            echo "âœ… X-Content-Type-Options í—¤ë” ì¡´ìž¬" >> security-headers.md
          else
            echo "âš ï¸ X-Content-Type-Options í—¤ë” ê¶Œìž¥" >> security-headers.md
          fi
          
          echo "" >> security-headers.md
          echo "### ì „ì²´ ì‘ë‹µ í—¤ë”" >> security-headers.md
          echo "\`\`\`" >> security-headers.md
          curl -s -I http://localhost:8787 >> security-headers.md
          echo "\`\`\`" >> security-headers.md

      - name: Comment security headers
        if: github.event_name == 'pull_request' && github.event.pull_request
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const fs = require('fs');
            if (fs.existsSync('security-headers.md')) {
              const report = fs.readFileSync('security-headers.md', 'utf8');
              console.log('Security headers analysis results:');
              console.log(report);
              
              // PR ëŒ“ê¸€ ìž‘ì„± ì‹œë„ (ì‹¤íŒ¨í•´ë„ ì›Œí¬í”Œë¡œëŠ” ê³„ì† ì§„í–‰)
              try {
                if (github.event.pull_request && github.event.pull_request.number) {
                  await github.rest.issues.createComment({
                    issue_number: github.event.pull_request.number,
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    body: report
                  });
                  console.log('Security headers ëŒ“ê¸€ ìž‘ì„± ì„±ê³µ');
                } else {
                  console.log('PR ì»¨í…ìŠ¤íŠ¸ê°€ ì—†ì–´ ëŒ“ê¸€ ìž‘ì„±ì„ ê±´ë„ˆëœë‹ˆë‹¤.');
                }
              } catch (commentError) {
                console.log('Security headers ëŒ“ê¸€ ìž‘ì„± ì‹¤íŒ¨ (ê¶Œí•œ ë¬¸ì œì¼ ìˆ˜ ìžˆìŒ):', commentError.message);
                // ëŒ“ê¸€ ìž‘ì„± ì‹¤íŒ¨ëŠ” ë¬´ì‹œí•˜ê³  ê³„ì† ì§„í–‰
              }
            }

  license-compliance:
    name: License Compliance Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Install license checker
        run: pnpm add -g license-checker

      - name: Check licenses
        run: |
          echo "## ðŸ“„ ë¼ì´ì„ ìŠ¤ í˜¸í™˜ì„± ê²€ì‚¬" > license-report.md
          echo "" >> license-report.md
          
          license-checker --json > licenses.json
          
          # í—ˆìš©ë˜ì§€ ì•ŠëŠ” ë¼ì´ì„ ìŠ¤ í™•ì¸
          FORBIDDEN_LICENSES="GPL-2.0,GPL-3.0,AGPL-1.0,AGPL-3.0"
          
          node -e "
          const fs = require('fs');
          const licenses = JSON.parse(fs.readFileSync('licenses.json', 'utf8'));
          const forbidden = '$FORBIDDEN_LICENSES'.split(',');
          
          let hasIssues = false;
          console.log('### ë¼ì´ì„ ìŠ¤ ë¶„ì„ ê²°ê³¼');
          
          Object.entries(licenses).forEach(([pkg, info]) => {
            if (forbidden.some(f => info.licenses && info.licenses.includes(f))) {
              console.log(\`âŒ \${pkg}: \${info.licenses} (í—ˆìš©ë˜ì§€ ì•ŠìŒ)\`);
              hasIssues = true;
            }
          });
          
          if (!hasIssues) {
            console.log('âœ… ëª¨ë“  ì˜ì¡´ì„±ì´ í˜¸í™˜ ê°€ëŠ¥í•œ ë¼ì´ì„ ìŠ¤ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.');
          }
          " >> license-report.md

      - name: Upload license report
        uses: actions/upload-artifact@v4
        with:
          name: license-report
          path: |
            license-report.md
            licenses.json
          retention-days: 30
